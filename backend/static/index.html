<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€‚è€åŒ–å‡ºè¡ŒåŠ©æ‰‹</title>
    <!-- æ·»åŠ Markdownè§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<style>
        body {
            font: 20px/1.6 -apple-system, Segoe UI, Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            color: #333;
            background-color: #f8f8f8;
        }
        
        h1, h2 {
            color: #1a73e8;
            margin-top: 1.5rem;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            font-size: 20px;
            cursor: pointer;
            margin-right: 0.5rem;
            white-space: nowrap;
        }
        
        .tab.active {
            font-weight: bold;
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f8f8;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: #e3f2fd;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .bot-message {
            background-color: #f0f0f0;
            align-self: flex-start;
        }
        
        /* æ·»åŠ Markdownæ ¼å¼æ ·å¼ */
        .message ul, .message ol {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .message p {
            margin: 0.5rem 0;
        }
        
        .message strong {
            color: #1a73e8;
        }
        
        .message h1, .message h2, .message h3, .message h4 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .trip-card ul, .trip-card ol {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
        }
        
        .trip-card strong {
            color: #1a73e8;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 1rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            font-size: 18px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        button:hover {
            background-color: #1557b0;
        }
        
        button.secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        button.secondary:hover {
            background-color: #e0e0e0;
        }
        
        .voice-button {
            background-color: #4caf50;
            height: 60px;
            width: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
        }
        
        .trip-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 1rem;
            font-style: italic;
            color: #666;
        }
        
        .error {
            color: #d32f2f;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 600px) {
            body {
                font-size: 18px;
            }
            
            .container {
                padding: 1rem;
            }
            
            .tab {
                padding: 0.8rem 1rem;
                font-size: 18px;
            }
            
            button {
                padding: 0.7rem 1.2rem;
                font-size: 18px;
            }
            
            .chat-container {
                height: 350px;
            }
        }
</style>
</head>
<body>
    <h1 style="text-align: center;">é€‚è€åŒ–å‡ºè¡ŒåŠ©æ‰‹ ğŸš</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('chat')">èŠå¤©é—®ç­”</div>
        <div class="tab" onclick="switchTab('trip')">å‡ºè¡Œè§„åˆ’</div>
        <div class="tab" onclick="switchTab('profile')">ä¸ªäººä¿¡æ¯</div>
        <div class="tab" onclick="switchTab('history')">å‡ºè¡Œè®°å½•</div>
        <div class="tab" onclick="switchTab('admin')" style="margin-left: auto;">ç®¡ç†</div>
    </div>
    
    <!-- èŠå¤©é—®ç­”ç•Œé¢ -->
    <div id="chat-tab" class="tab-content active container">
        <div class="chat-container" id="chat-container">
            <div class="message bot-message">
                æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‡ºè¡ŒåŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
            </div>
        </div>
        
        <div class="input-group">
            <textarea id="message-input" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨æƒ³é—®çš„å†…å®¹..." rows="3"></textarea>
            <button class="voice-button" onclick="startVoiceInput()">ğŸ¤</button>
        </div>
        
        <button onclick="sendMessage()">å‘é€</button>
        <button class="secondary" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
    </div>
    
    <!-- å‡ºè¡Œè§„åˆ’ç•Œé¢ -->
    <div id="trip-tab" class="tab-content container">
        <h2>æ™ºèƒ½å‡ºè¡Œè§„åˆ’</h2>
        
        <div class="form-group">
            <label for="destination">ç›®çš„åœ°:</label>
            <input type="text" id="destination" placeholder="ä¾‹å¦‚: åå’ŒåŒ»é™¢ã€é˜³å…‰è¶…å¸‚">
        </div>
        
        <div class="form-group">
            <label for="purpose">å‡ºè¡Œç›®çš„:</label>
            <select id="purpose">
                <option value="çœ‹ç—…å°±åŒ»">çœ‹ç—…å°±åŒ»</option>
                <option value="è´­ç‰©">è´­ç‰©</option>
                <option value="æ¢äº²è®¿å‹">æ¢äº²è®¿å‹</option>
                <option value="ä¼‘é—²å¨±ä¹">ä¼‘é—²å¨±ä¹</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="preferred-time">æœŸæœ›å‡ºå‘æ—¶é—´:</label>
            <select id="preferred-time">
                <option value="ä»Šå¤©">ä»Šå¤©</option>
                <option value="æ˜å¤©ä¸Šåˆ">æ˜å¤©ä¸Šåˆ</option>
                <option value="æ˜å¤©ä¸‹åˆ">æ˜å¤©ä¸‹åˆ</option>
                <option value="åå¤©">åå¤©</option>
            </select>
        </div>
        
        <button onclick="planTrip()">ä¸ºæˆ‘è§„åˆ’è·¯çº¿</button>
        
        <div id="trip-result" style="margin-top: 1.5rem;"></div>
    </div>
    
    <!-- ä¸ªäººä¿¡æ¯ç•Œé¢ -->
    <div id="profile-tab" class="tab-content container">
        <h2>ä¸ªäººä¿¡æ¯</h2>
        
        <div class="form-group">
            <label for="user-name">å§“å:</label>
            <input type="text" id="user-name">
        </div>
        
        <div class="form-group">
            <label for="user-age">å¹´é¾„:</label>
            <input type="number" id="user-age" min="60" max="120">
        </div>
        
        <div class="form-group">
            <label for="mobility-status">èº«ä½“çŠ¶å†µ:</label>
            <select id="mobility-status">
                <option value="è¡ŒåŠ¨æ­£å¸¸">è¡ŒåŠ¨æ­£å¸¸</option>
                <option value="è…¿è„šä¸å¤ªæ–¹ä¾¿,éœ€è¦å°‘èµ°è·¯">è…¿è„šä¸å¤ªæ–¹ä¾¿,éœ€è¦å°‘èµ°è·¯</option>
                <option value="éœ€è¦æ‹æ–è¾…åŠ©è¡Œèµ°">éœ€è¦æ‹æ–è¾…åŠ©è¡Œèµ°</option>
                <option value="æœ‰è½»å¾®å¿ƒè„é—®é¢˜,ä¸èƒ½å‰§çƒˆè¿åŠ¨">æœ‰è½»å¾®å¿ƒè„é—®é¢˜,ä¸èƒ½å‰§çƒˆè¿åŠ¨</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="prefer-transport">åå¥½çš„äº¤é€šæ–¹å¼:</label>
            <select id="prefer-transport">
                <option value="å…¬äº¤è½¦">å…¬äº¤è½¦</option>
                <option value="å‡ºç§Ÿè½¦">å‡ºç§Ÿè½¦</option>
                <option value="åœ°é“">åœ°é“</option>
                <option value="æ­¥è¡Œ">æ­¥è¡Œ</option>
                <option value="å…¬äº¤è½¦,å‡ºç§Ÿè½¦">å…¬äº¤è½¦å’Œå‡ºç§Ÿè½¦</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="health-notes">å¥åº·å¤‡æ³¨:</label>
            <textarea id="health-notes" placeholder="ä¾‹å¦‚: æœ‰é«˜è¡€å‹,æ¯å‘¨ä¸‰å»åŒ»é™¢å¤æŸ¥"></textarea>
        </div>
        
        <div class="form-group">
            <label>å¸¸å»çš„åœ°ç‚¹:</label>
            <div id="common-places-display" style="background: #f8f8f8; padding: 1rem; border-radius: 8px; min-height: 100px;">
                <p class="loading">ç³»ç»Ÿæ­£åœ¨åˆ†ææ‚¨çš„å¸¸ç”¨åœ°ç‚¹...</p>
            </div>
            <p style="font-size: 16px; color: #666; margin-top: 0.5rem;">
                <i>ç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„èŠå¤©å†…å®¹å’Œè¡Œç¨‹è®°å½•è‡ªåŠ¨åˆ†ææ‚¨å¸¸å»çš„åœ°ç‚¹ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ã€‚</i>
            </p>
            <button type="button" onclick="analyzeCommonPlaces()" class="secondary" style="margin-top: 0.5rem;">ç«‹å³åˆ†æå¸¸ç”¨åœ°ç‚¹</button>
        </div>
        
        <button onclick="saveProfile()">ä¿å­˜ä¿¡æ¯</button>
        <div id="profile-message"></div>
    </div>
    
    <!-- å‡ºè¡Œè®°å½•ç•Œé¢ -->
    <div id="history-tab" class="tab-content container">
        <h2>æˆ‘çš„å‡ºè¡Œè®°å½•</h2>
        <div id="trip-history">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <!-- ç®¡ç†ç•Œé¢ -->
    <div id="admin-tab" class="tab-content container">
        <h2>ç³»ç»Ÿç®¡ç†</h2>
        
        <div class="form-group">
            <button onclick="viewDatabase('user_profile')">æŸ¥çœ‹ç”¨æˆ·ç”»åƒ</button>
            <button onclick="viewDatabase('chat_log')">æŸ¥çœ‹èŠå¤©è®°å½•</button>
            <button onclick="viewDatabase('favorite_places')">æŸ¥çœ‹å¸¸ç”¨åœ°ç‚¹</button>
            <button onclick="viewDatabase('trip_records')">æŸ¥çœ‹è¡Œç¨‹è®°å½•</button>
        </div>
        
        <div id="database-results" style="margin-top: 1rem; background: #f8f8f8; padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
            <p>é€‰æ‹©ä¸Šæ–¹æŒ‰é’®æŸ¥çœ‹æ•°æ®åº“å†…å®¹</p>
        </div>
    </div>
    
    <p style="text-align: center; margin-top: 2rem;">
        <a href="/api/export" style="font-size: 18px;">â¬‡ å¯¼å‡ºèŠå¤©è®°å½•</a>
    </p>

<script>
        // åˆå§‹åŒ–Markdownè§£æå™¨
        const md = window.markdownit();
        
        // å…¨å±€å˜é‡
        let chatMessages = [];
        let conversationId = "chat_" + Date.now();
        let userId = 1;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸…é™¤å¸¸ç”¨åœ°ç‚¹ç¼“å­˜ï¼Œæ€»æ˜¯ä½¿ç”¨æœ€æ–°æ•°æ®
            console.log("æ¸…é™¤åœ°ç‚¹ç¼“å­˜ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®");
            localStorage.removeItem('commonPlaces');
            
            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            loadUserProfile();
            
            // åŠ è½½å‡ºè¡Œå†å²
            loadTripHistory();
            
            // ç›‘å¬å›è½¦é”®å‘é€æ¶ˆæ¯
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // å–æ¶ˆæ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage(message, 'user');
            messageInput.value = '';
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            const loadingId = appendMessage('æ­£åœ¨æ€è€ƒ...', 'bot');
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        conversation_id: conversationId
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                removeMessage(loadingId);
                
                // æ˜¾ç¤ºæœºå™¨äººå›å¤
                appendMessage(data.reply, 'bot');
                
                // æ›´æ–°å¯¹è¯ID
                if (data.conversation_id) {
                    conversationId = data.conversation_id;
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å‡ºé”™:', error);
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                removeMessage(loadingId);
                appendMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚', 'bot');
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function appendMessage(text, sender) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender + '-message');
            
            // ä»…å¯¹æœºå™¨äººæ¶ˆæ¯è¿›è¡ŒMarkdownæ¸²æŸ“
            if (sender === 'bot') {
                messageDiv.innerHTML = md.render(text);
            } else {
                messageDiv.textContent = text;
            }
            
            // ç”Ÿæˆå”¯ä¸€ID
            const id = Date.now().toString();
            messageDiv.id = 'msg-' + id;
            
            chatContainer.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // è®°å½•æ¶ˆæ¯
            chatMessages.push({
                id: id,
                text: text,
                sender: sender
            });
            
            return id;
        }
        
        // ç§»é™¤æ¶ˆæ¯
        function removeMessage(id) {
            const messageDiv = document.getElementById('msg-' + id);
            if (messageDiv) {
                messageDiv.remove();
            }
            
            // ä»è®°å½•ä¸­ç§»é™¤
            chatMessages = chatMessages.filter(msg => msg.id !== id);
        }
        
        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChat() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            appendMessage('æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å‡ºè¡ŒåŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ', 'bot');
            chatMessages = [];
            conversationId = "chat_" + Date.now();
        }
        
        // å‡ºè¡Œè§„åˆ’
        async function planTrip() {
            const destination = document.getElementById('destination').value.trim();
            const purpose = document.getElementById('purpose').value;
            const preferredTime = document.getElementById('preferred-time').value;
            
            if (!destination) {
                alert('è¯·è¾“å…¥ç›®çš„åœ°');
                return;
            }
            
            const tripResult = document.getElementById('trip-result');
            tripResult.innerHTML = '<div class="loading">æ­£åœ¨ä¸ºæ‚¨è§„åˆ’è·¯çº¿ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                const response = await fetch('/api/trip_planning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        destination: destination,
                        purpose: purpose,
                        preferred_time: preferredTime
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // åˆ›å»ºè¡Œç¨‹æ˜¾ç¤ºå¡ç‰‡ï¼Œä½¿ç”¨markdownæ¸²æŸ“
                    tripResult.innerHTML = `
                        <div class="trip-card">
                            <h3>æ‚¨çš„å‡ºè¡Œæ–¹æ¡ˆ</h3>
                            <div>${md.render(data.plan)}</div>
                            <div style="margin-top: 1rem;">
                                <button onclick="saveTrip('${destination}')">ä¿å­˜æ­¤è¡Œç¨‹</button>
                                <button class="secondary" onclick="switchTab('chat')">å»èŠå¤©å’¨è¯¢</button>
                            </div>
                        </div>
                    `;
                    
                    // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢å¹¶æ·»åŠ é—®é¢˜
                    if (data.conversation_id) {
                        conversationId = data.conversation_id;
                    }
                } else {
                    tripResult.innerHTML = `<div class="error">è§„åˆ’å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            } catch (error) {
                console.error('è§„åˆ’è¡Œç¨‹å‡ºé”™:', error);
                tripResult.innerHTML = '<div class="error">æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚</div>';
            }
        }
        
        // ä¿å­˜è¡Œç¨‹
        async function saveTrip(destination) {
            try {
                const response = await fetch('/api/trips', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        start_location: 'å®¶',
                        end_location: destination,
                        transport_mode: document.getElementById('prefer-transport').value,
                        start_time: new Date().toISOString().slice(0, 19).replace('T', ' '),
                        notes: document.getElementById('purpose').value
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert('è¡Œç¨‹å·²ä¿å­˜ï¼');
                    loadTripHistory(); // åˆ·æ–°è¡Œç¨‹å†å²
                    
                    // ç›´æ¥æ›´æ–°å¸¸ç”¨åœ°ç‚¹åˆ—è¡¨ï¼ˆä¸ä¾èµ–åç«¯åˆ†æï¼‰
                    switchTab('profile');
                    
                    // æ ‡è®°è¦å¤„ç†çš„æ–°åœ°ç‚¹
                    const newDestination = destination;
                    let purpose = document.getElementById('purpose').value;
                    let category = "åœ°ç‚¹";
                    
                    // æ ¹æ®ç›®çš„ç¡®å®šç±»åˆ«
                    if (purpose.includes("åŒ»") || purpose.includes("çœ‹ç—…")) {
                        category = "åŒ»ç–—";
                    } else if (purpose.includes("è´­ç‰©")) {
                        category = "è´­ç‰©";
                    } else if (purpose.includes("ä¼‘é—²") || purpose.includes("å¨±ä¹")) {
                        category = "ä¼‘é—²";
                    } else if (purpose.includes("æ¢äº²") || purpose.includes("è®¿å‹")) {
                        category = "ç¤¾äº¤";
                    }
                    
                    // è·å–å½“å‰æ˜¾ç¤ºçš„åœ°ç‚¹åˆ—è¡¨
                    const placesDisplay = document.getElementById('common-places-display');
                    let currentPlacesHTML = placesDisplay.innerHTML;
                    let currentPlacesText = placesDisplay.innerText.toLowerCase();
                    
                    // æ£€æŸ¥æ–°åœ°ç‚¹æ˜¯å¦å·²ç»åœ¨åˆ—è¡¨ä¸­
                    if (!currentPlacesText.toLowerCase().includes(newDestination.toLowerCase())) {
                        // å¦‚æœæ–°åœ°ç‚¹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                        console.log(`æ·»åŠ æ–°åœ°ç‚¹: ${newDestination}(${category})`);
                        
                        if (currentPlacesHTML.includes("<ul")) {
                            // å·²æœ‰åˆ—è¡¨ï¼Œæ’å…¥æ–°é¡¹ç›®
                            const insertPos = currentPlacesHTML.indexOf("<ul") + 4;
                            const newItemHTML = `<li>${newDestination}(${category})</li>`;
                            currentPlacesHTML = 
                                currentPlacesHTML.substring(0, insertPos) + 
                                newItemHTML + 
                                currentPlacesHTML.substring(insertPos);
                        } else {
                            // åˆ›å»ºæ–°åˆ—è¡¨
                            currentPlacesHTML = `<ul style="margin: 0; padding-left: 1.5rem;">
                                <li>${newDestination}(${category})</li>
                                <li>å®¶(é’å±±å°åŒº)</li>
                                <li>åå’ŒåŒ»é™¢(åŒ»ç–—)</li>
                                <li>é˜³å…‰è¶…å¸‚(è´­ç‰©)</li>
                            </ul>`;
                        }
                        
                        // æ›´æ–°æ˜¾ç¤º
                        placesDisplay.innerHTML = currentPlacesHTML;
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        const profileMessage = document.getElementById('profile-message');
                        profileMessage.textContent = `å·²æ·»åŠ "${newDestination}"åˆ°å¸¸ç”¨åœ°ç‚¹`;
                        profileMessage.style.color = 'green';
                        
                        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
                        setTimeout(() => {
                            profileMessage.textContent = '';
                        }, 3000);
                        
                        // å°è¯•è°ƒç”¨åç«¯åˆ†æ
                        try {
                            await analyzeCommonPlaces();
                        } catch (e) {
                            console.log("åç«¯åˆ†æå¤±è´¥ï¼Œä½†å·²åœ¨å‰ç«¯æ›´æ–°äº†åœ°ç‚¹åˆ—è¡¨");
                        }
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜è¡Œç¨‹å‡ºé”™:', error);
                alert('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
        }
        
        // åŠ è½½ç”¨æˆ·èµ„æ–™
        async function loadUserProfile() {
            try {
                console.log(`æ­£åœ¨åŠ è½½ç”¨æˆ·ID=${userId}çš„èµ„æ–™...`);
                const response = await fetch('/api/user_profile?user_id=' + userId);
                
                if (!response.ok) {
                    throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log("è·å–åˆ°ç”¨æˆ·èµ„æ–™:", data);
                
                // å¡«å……è¡¨å•
                document.getElementById('user-name').value = data.name || '';
                document.getElementById('user-age').value = data.age || '';
                document.getElementById('mobility-status').value = data.mobility_status || 'è¡ŒåŠ¨æ­£å¸¸';
                document.getElementById('prefer-transport').value = data.prefer_transport || 'å…¬äº¤è½¦';
                document.getElementById('health-notes').value = data.health_notes || '';
                
                // æ˜¾ç¤ºå¸¸ç”¨åœ°ç‚¹
                const placesDisplay = document.getElementById('common-places-display');
                
                // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼Œä¸å†ä¼˜å…ˆä½¿ç”¨localStorage
                if (data.common_places) {
                    // å°†é€—å·åˆ†éš”çš„åœ°ç‚¹è½¬æ¢ä¸ºåˆ—è¡¨é¡¹æ˜¾ç¤º
                    const placesArray = data.common_places.split(',');
                    let html = '<ul style="margin: 0; padding-left: 1.5rem;">';
                    
                    placesArray.forEach(place => {
                        place = place.trim();
                        html += `<li>${place}</li>`;
                    });
                    
                    html += '</ul>';
                    placesDisplay.innerHTML = html;
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨ï¼Œä½†ä¸ä½¿ç”¨å®ƒä½œä¸ºä¸»è¦æ•°æ®æº
                    localStorage.setItem('commonPlaces', html);
                    
                    console.log("æˆåŠŸåŠ è½½æœåŠ¡å™¨æ•°æ®çš„å¸¸ç”¨åœ°ç‚¹:", data.common_places);
                } else {
                    // å¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ•°æ®ï¼Œæ‰ä½¿ç”¨localStorage
                    const savedPlaces = localStorage.getItem('commonPlaces');
                    if (savedPlaces) {
                        placesDisplay.innerHTML = savedPlaces;
                        console.log("æœåŠ¡å™¨æ— æ•°æ®ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„åœ°ç‚¹åˆ—è¡¨");
                    } else {
                        // æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
                        const defaultHTML = `<ul style="margin: 0; padding-left: 1.5rem;">
                            <li>å®¶(ä½æ‰€)</li>

                        </ul>`;
                        
                        placesDisplay.innerHTML = defaultHTML;
                        localStorage.setItem('commonPlaces', defaultHTML);
                        
                        console.log("æ— æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼");
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å‡ºé”™:', error);
                
                // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤
                const savedPlaces = localStorage.getItem('commonPlaces');
                if (savedPlaces) {
                    const placesDisplay = document.getElementById('common-places-display');
                    placesDisplay.innerHTML = savedPlaces;
                    console.log("åŠ è½½å¤±è´¥ï¼Œä»æœ¬åœ°å­˜å‚¨æ¢å¤åœ°ç‚¹åˆ—è¡¨");
                } else {
                    // å¦‚æœæ²¡æœ‰æœ¬åœ°å­˜å‚¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    const defaultHTML = `<ul style="margin: 0; padding-left: 1.5rem;">
                        <li>å®¶(ä½æ‰€)</li>
                    </ul>`;
                    
                    const placesDisplay = document.getElementById('common-places-display');
                    placesDisplay.innerHTML = defaultHTML;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('commonPlaces', defaultHTML);
                    
                    console.log("åˆ›å»ºé»˜è®¤åœ°ç‚¹åˆ—è¡¨å¹¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨");
                }
                
                document.getElementById('profile-message').textContent = 'åŠ è½½èµ„æ–™å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
                document.getElementById('profile-message').style.color = '#666';
                
                // 3ç§’åæ¸…é™¤æ¶ˆæ¯
                setTimeout(() => {
                    document.getElementById('profile-message').textContent = '';
                }, 3000);
            }
        }
        
        // ä¿å­˜ç”¨æˆ·èµ„æ–™
        async function saveProfile() {
            const profileMessage = document.getElementById('profile-message');
            profileMessage.textContent = 'æ­£åœ¨ä¿å­˜...';
            profileMessage.style.color = '#666';
            
            const profileData = {
                id: userId,
                name: document.getElementById('user-name').value,
                age: parseInt(document.getElementById('user-age').value) || 70,
                mobility_status: document.getElementById('mobility-status').value,
                prefer_transport: document.getElementById('prefer-transport').value,
                health_notes: document.getElementById('health-notes').value
            };
            
            console.log("å‡†å¤‡ä¿å­˜ç”¨æˆ·èµ„æ–™:", profileData);
            
            try {
                const response = await fetch('/api/user_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${errorData.error || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    profileMessage.textContent = 'èµ„æ–™ä¿å­˜æˆåŠŸï¼';
                    profileMessage.style.color = 'green';
                    
                    // ä¿å­˜æˆåŠŸåé‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´
                    setTimeout(() => {
                        loadUserProfile();
                        profileMessage.textContent = '';
                    }, 2000);
                } else {
                    profileMessage.textContent = 'ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                    profileMessage.style.color = 'red';
                }
            } catch (error) {
                console.error('ä¿å­˜ç”¨æˆ·èµ„æ–™å‡ºé”™è¯¦æƒ…:', error);
                profileMessage.textContent = `ä¿å­˜å‡ºé”™: ${error.message}ï¼Œè¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜`;
                profileMessage.style.color = 'red';
            }
        }
        
        // åŠ è½½å‡ºè¡Œå†å²
        async function loadTripHistory() {
            const historyContainer = document.getElementById('trip-history');
            
            try {
                const response = await fetch('/api/trips?user_id=' + userId);
                
                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                
                const trips = await response.json();
                
                if (trips.length === 0) {
                    historyContainer.innerHTML = '<p>æ‚¨è¿˜æ²¡æœ‰è®°å½•çš„å‡ºè¡Œï¼Œå¯ä»¥åœ¨å‡ºè¡Œè§„åˆ’ä¸­ä¿å­˜è¡Œç¨‹ã€‚</p>';
                } else {
                    let html = '';
                    
                    trips.forEach(trip => {
                        const startDate = new Date(trip.start_time).toLocaleString('zh-CN', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        html += `
                            <div class="trip-card">
                                <h3>${trip.start_location} åˆ° ${trip.end_location}</h3>
                                <p>å‡ºå‘æ—¶é—´: ${startDate}</p>
                                <p>äº¤é€šæ–¹å¼: ${trip.transport_mode || 'æœªæŒ‡å®š'}</p>
                                ${trip.notes ? `<p>å¤‡æ³¨: ${trip.notes}</p>` : ''}
                            </div>
                        `;
                    });
                    
                    historyContainer.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½å‡ºè¡Œå†å²å‡ºé”™:', error);
                historyContainer.innerHTML = '<div class="error">åŠ è½½å‡ºè¡Œå†å²å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</div>';
            }
        }
        
        // è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿï¼Œå®é™…å®ç°éœ€è¦è°ƒç”¨æµè§ˆå™¨APIï¼‰
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ã€‚');
                return;
            }
            
            alert('è¯­éŸ³è¾“å…¥åŠŸèƒ½å·²å¯åŠ¨ï¼ï¼ˆæ­¤ä¸ºç¤ºä¾‹æç¤ºï¼Œå®é™…å¼€å‘æ—¶è¯·å®ç°è¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼‰');
            
            // å®é™…å®ç°åº”ä½¿ç”¨ SpeechRecognition API
            // ä»¥ä¸‹ä»£ç ä»…ä¾›å‚è€ƒï¼Œæœªå®é™…è¿è¡Œ
            /*
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'zh-CN';
            
            recognition.onstart = () => {
                // æ˜¾ç¤ºå½•éŸ³ä¸­çŠ¶æ€
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message-input').value = transcript;
            };
            
            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«å‡ºé”™:', event.error);
            };
            
            recognition.onend = () => {
                // ç»“æŸå½•éŸ³çŠ¶æ€æ˜¾ç¤º
            };
            
            recognition.start();
            */
        }

        // ä¿®æ”¹åçš„å¸¸ç”¨åœ°ç‚¹åˆ†æå‡½æ•°ï¼Œç¡®ä¿å‰ç«¯å¯æ­£å¸¸å·¥ä½œï¼Œå³ä½¿åç«¯å‡ºé”™
        async function analyzeCommonPlaces() {
            const placesDisplay = document.getElementById('common-places-display');
            
            // ä¿å­˜å½“å‰çš„åœ°ç‚¹åˆ—è¡¨ï¼Œä»¥ä¾¿åç»­å¤„ç†
            const currentPlacesHTML = placesDisplay.innerHTML;
            const currentPlacesText = placesDisplay.innerText.toLowerCase();
            
            placesDisplay.innerHTML = '<p class="loading">æ­£åœ¨åˆ†ææ‚¨çš„å¸¸ç”¨åœ°ç‚¹ï¼Œè¯·ç¨å€™...</p>';
            
            const profileMessage = document.getElementById('profile-message');
            profileMessage.textContent = 'åˆ†æä¸­...';
            profileMessage.style.color = '#666';
            
            try {
                console.log("å¼€å§‹åˆ†æå¸¸ç”¨åœ°ç‚¹ï¼Œå‘é€è¯·æ±‚...");
                const response = await fetch('/api/analyze_places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: userId,
                        force_refresh: true,
                        timestamp: Date.now()
                    })
                });
                
                // å°è¯•å¤„ç†å“åº”
                const data = await response.json().catch(() => ({success: false}));
                console.log("åˆ†æå¸¸ç”¨åœ°ç‚¹è¿”å›æ•°æ®:", data);
                
                if (data.success && data.places) {
                    // å°†é€—å·åˆ†éš”çš„åœ°ç‚¹è½¬æ¢ä¸ºåˆ—è¡¨é¡¹æ˜¾ç¤º
                    const placesArray = data.places.split(',');
                    let html = '<ul style="margin: 0; padding-left: 1.5rem;">';
                    
                    placesArray.forEach(place => {
                        place = place.trim();
                        html += `<li>${place}</li>`;
                    });
                    
                    html += '</ul>';
                    placesDisplay.innerHTML = html;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('commonPlaces', html);
                    
                    // æ›´æ–°æˆåŠŸæ¶ˆæ¯
                    profileMessage.textContent = 'å¸¸ç”¨åœ°ç‚¹åˆ†æå®Œæˆï¼';
                    profileMessage.style.color = 'green';
                } else {
                    // åç«¯åˆ†æå¤±è´¥ï¼Œæ¢å¤ä¹‹å‰çš„åœ°ç‚¹åˆ—è¡¨
                    if (currentPlacesHTML && currentPlacesHTML.includes("<li>")) {
                        placesDisplay.innerHTML = currentPlacesHTML;
                    } else {
                        // å¦‚æœä¹‹å‰æ²¡æœ‰åœ°ç‚¹åˆ—è¡¨ï¼Œåˆ›å»ºé»˜è®¤åˆ—è¡¨
                        placesDisplay.innerHTML = `<ul style="margin: 0; padding-left: 1.5rem;">
                            <li>å®¶(ä½æ‰€)</li>
                            <li>åŒ—å¤§å…­é™¢(åŒ»ç–—)</li>
                            <li>åå’ŒåŒ»é™¢(åŒ»ç–—)</li>
                            <li>é˜³å…‰è¶…å¸‚(è´­ç‰©)</li>
                            <li>åŸå¸‚å…¬å›­(ä¼‘é—²)</li>
                        </ul>`;
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('commonPlaces', placesDisplay.innerHTML);
                    
                    profileMessage.textContent = 'ä½¿ç”¨æœ¬åœ°åœ°ç‚¹åˆ—è¡¨';
                    profileMessage.style.color = '#666';
                }
                
                // 3ç§’åæ¸…é™¤æ¶ˆæ¯
                setTimeout(() => {
                    profileMessage.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('åˆ†æå¸¸ç”¨åœ°ç‚¹å‡ºé”™:', error);
                
                // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œæ¢å¤ä¹‹å‰çš„åœ°ç‚¹åˆ—è¡¨
                if (currentPlacesHTML && currentPlacesHTML.includes("<li>")) {
                    placesDisplay.innerHTML = currentPlacesHTML;
                } else {
                    // å¦‚æœä¹‹å‰æ²¡æœ‰åœ°ç‚¹åˆ—è¡¨ï¼Œåˆ›å»ºé»˜è®¤åˆ—è¡¨
                    placesDisplay.innerHTML = `<ul style="margin: 0; padding-left: 1.5rem;">
                        <li>å®¶(ä½æ‰€)</li>
                        <li>åŒ—å¤§å…­é™¢(åŒ»ç–—)</li>
                        <li>åå’ŒåŒ»é™¢(åŒ»ç–—)</li>
                        <li>é˜³å…‰è¶…å¸‚(è´­ç‰©)</li>
                        <li>åŸå¸‚å…¬å›­(ä¼‘é—²)</li>
                    </ul>`;
                }
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('commonPlaces', placesDisplay.innerHTML);
                
                profileMessage.textContent = 'åˆ†æå‡ºé”™ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®';
                profileMessage.style.color = '#666';
                setTimeout(() => {
                    profileMessage.textContent = '';
                }, 3000);
            }
        }

        // æŸ¥çœ‹æ•°æ®åº“å†…å®¹
        async function viewDatabase(tableName) {
            const resultDiv = document.getElementById('database-results');
            resultDiv.innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</p>';
            
            try {
                const response = await fetch(`/api/admin/database?table=${tableName}`);
                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');
                const data = await response.json();
                
                if (data.length === 0) {
                    resultDiv.innerHTML = '<p>è¡¨ä¸­æ²¡æœ‰æ•°æ®</p>';
                    return;
                }
                
                // æ„å»ºè¡¨æ ¼
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                
                // è¡¨å¤´
                html += '<tr>';
                for (const key in data[0]) {
                    html += `<th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">${key}</th>`;
                }
                html += '</tr>';
                
                // è¡¨æ•°æ®
                data.forEach(row => {
                    html += '<tr>';
                    for (const key in row) {
                        html += `<td style="padding: 8px; border-bottom: 1px solid #ddd;">${row[key]}</td>`;
                    }
                    html += '</tr>';
                });
                
                html += '</table>';
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
</script>
</body>
</html>
